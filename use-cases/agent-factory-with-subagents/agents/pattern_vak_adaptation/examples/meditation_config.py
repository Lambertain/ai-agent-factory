"""
Конфигурация VAK адаптации для медитативных практик PatternShift.

Содержит примеры конфигураций для адаптации медитаций
под различные сенсорные модальности.
"""

from typing import Dict, Any, List
from ..dependencies import (
    PatternVAKAdaptationDependencies,
    VAKModalityType,
    AdaptationDepth,
    PatternShiftModuleType,
    create_vak_adaptation_dependencies
)


def create_meditation_config(api_key: str) -> PatternVAKAdaptationDependencies:
    """
    Создать конфигурацию для адаптации медитативных практик.

    Args:
        api_key: API ключ для LLM

    Returns:
        Настроенные зависимости для медитаций
    """
    return create_vak_adaptation_dependencies(
        api_key=api_key,
        adaptation_depth=AdaptationDepth.DEEP,
        enable_multimodal=True,
        enable_safety_validation=True,
        trauma_informed_adaptations=True,
        preserve_therapeutic_integrity=True,
        max_adaptation_time_seconds=40.0,
        batch_adaptation_size=8,
        knowledge_tags=["meditation", "mindfulness", "vak", "pattern-shift", "relaxation"]
    )


# Примеры адаптации медитативных практик
MEDITATION_EXAMPLES = {
    "breath_awareness": {
        "visual": {
            "title": "Визуальная медитация на дыхание",
            "content": """
            Сядьте комфортно и направьте взгляд на точку перед собой.
            Представьте, как ваше дыхание имеет цвет - возможно, спокойный голубой или теплый золотой.

            На вдохе визуализируйте, как цветной поток входит через нос и наполняет легкие.
            Наблюдайте, как этот светящийся воздух распространяется по всему телу.

            На выдохе смотрите, как поток выходит, унося с собой все ненужное - возможно, в виде серого тумана.
            Сфокусируйтесь на этой яркой картине циркуляции дыхания.

            Если ум отвлекается, мягко верните внимание к этому цветному потоку дыхания.
            """,
            "duration": "10-15 минут",
            "key_elements": ["визуализация цвета", "наблюдение потока", "фокус на образах"],
            "difficulty": "начальный"
        },
        "auditory": {
            "title": "Аудиальная медитация на дыхание",
            "content": """
            Сядьте удобно и закройте глаза, настраиваясь на звуки дыхания.
            Прислушайтесь к естественному ритму вдоха и выдоха.

            На вдохе мысленно произносите 'СО', слушая, как этот звук резонирует в груди.
            На выдохе произносите 'ХАМ', ощущая вибрацию этого звука.

            Позвольте этой мантре создать внутренний ритм: СО-ХАМ, СО-ХАМ.
            Слушайте, как дыхание и звуки синхронизируются в гармоничную мелодию.

            Если ум отвлекается на другие звуки, мягко возвращайтесь к внутреннему ритму СО-ХАМ.
            """,
            "duration": "10-15 минут",
            "key_elements": ["внутренние звуки", "мантра", "ритм дыхания"],
            "difficulty": "начальный"
        },
        "kinesthetic": {
            "title": "Кинестетическая медитация на дыхание",
            "content": """
            Устройтесь максимально комфортно, ощущая контакт тела с поверхностью.
            Поместите одну руку на грудь, другую на живот.

            На вдохе почувствуйте, как живот мягко поднимается, грудь расширяется.
            Ощутите прохладу воздуха, входящего через ноздри.

            На выдохе прочувствуйте, как тело естественно опускается и расслабляется.
            Почувствуйте тепло выдыхаемого воздуха.

            Сосредоточьтесь на физических ощущениях каждого вдоха и выдоха.
            Если ум блуждает, мягко возвращайтесь к чувствованию движения дыхания в теле.
            """,
            "duration": "10-15 минут",
            "key_elements": ["телесные ощущения", "физический контакт", "движение дыхания"],
            "difficulty": "начальный"
        }
    },

    "body_scan": {
        "visual": {
            "title": "Визуальное сканирование тела",
            "content": """
            Лягте комфортно и представьте ваше тело как ландшафт, который вы изучаете с высоты.
            Начните с макушки головы - увидьте эту область как светящуюся точку.

            Медленно перемещайте этот мягкий свет вниз по телу:
            - Лоб и глаза - наблюдайте, как свет освещает эти области
            - Щеки и челюсть - смотрите, как расслабляется каждая мышца под светом
            - Шея и плечи - визуализируйте, как напряжение растворяется в свете

            Продолжайте это медленное путешествие света по всему телу.
            Наблюдайте каждую область как отдельную картину расслабления.
            """,
            "duration": "20-25 минут",
            "key_elements": ["визуализация света", "последовательные образы", "наблюдение расслабления"],
            "difficulty": "средний"
        },
        "auditory": {
            "title": "Аудиальное сканирование тела",
            "content": """
            Устройтесь удобно и настройтесь на внутренние звуки тела.
            Начните с макушки головы, мысленно произнося: "Расслабляется макушка".

            Медленно перемещайтесь вниз, проговаривая каждую часть:
            - "Расслабляется лоб" - прислушайтесь к отклику этой области
            - "Расслабляются глаза" - услышьте внутреннее согласие
            - "Расслабляется челюсть" - почувствуйте звуковой отклик расслабления

            Продолжайте этот внутренний диалог с каждой частью тела.
            Слушайте, как тело "отвечает" на ваши слова расслаблением.
            """,
            "duration": "20-25 минут",
            "key_elements": ["внутренний диалог", "проговаривание", "слушание откликов"],
            "difficulty": "средний"
        },
        "kinesthetic": {
            "title": "Кинестетическое сканирование тела",
            "content": """
            Лягте максимально удобно, почувствовав полный контакт тела с поверхностью.
            Начните с макушки головы - просто ощутите эту область, не пытаясь ничего изменить.

            Медленно перемещайте внимание по телу, глубоко чувствуя каждую зону:
            - Лоб - какие ощущения здесь присутствуют?
            - Глаза - есть ли напряжение или расслабленность?
            - Челюсть - чувствуется ли сжатие или мягкость?

            При обнаружении напряжения не пытайтесь его убрать - просто дышите в эту область.
            Позвольте каждой части тела рассказать вам о своих ощущениях.
            """,
            "duration": "20-25 минут",
            "key_elements": ["глубокое чувствование", "принятие ощущений", "дыхание в области"],
            "difficulty": "средний"
        }
    },

    "loving_kindness": {
        "visual": {
            "title": "Визуальная медитация любящей доброты",
            "content": """
            Сядьте комфортно и представьте себя в центре теплого, золотистого света.
            Этот свет представляет безусловную любовь и доброту.

            Визуализируйте, как этот свет исходит из вашего сердца и окутывает вас полностью.
            Увидьте, как ваше лицо становится мягким и спокойным в этом свете.

            Теперь представьте близкого человека рядом с вами, тоже окутанного этим светом.
            Наблюдайте, как любовь перетекает между вами двумя яркими потоками.

            Постепенно расширяйте круг света, включая:
            - Нейтральных людей
            - Сложных людей в вашей жизни
            - Всех живых существ

            Видите ли вы, как весь мир светится этим золотым светом доброты?
            """,
            "duration": "15-20 минут",
            "key_elements": ["визуализация света", "образы людей", "расширение круга любви"],
            "difficulty": "продвинутый"
        },
        "auditory": {
            "title": "Аудиальная медитация любящей доброты",
            "content": """
            Сядьте удобно и настройтесь на голос доброты в своем сердце.
            Начните с себя, мысленно произнося с теплой интонацией:

            "Пусть я буду счастлив. Пусть я буду здоров.
            Пусть я буду в безопасности. Пусть я живу с легкостью."

            Слушайте, как эти слова резонируют в груди. Повторите несколько раз.

            Теперь представьте голос близкого человека и скажите о нем:
            "Пусть ты будешь счастлив. Пусть ты будешь здоров..."

            Продолжайте распространять эти добрые пожелания:
            - На нейтральных людей
            - На сложных людей
            - На всех живых существ

            Слушайте, как ваш голос становится все более мягким и любящим.
            """,
            "duration": "15-20 минут",
            "key_elements": ["добрые пожелания", "интонация любви", "расширение круга"],
            "difficulty": "продвинутый"
        },
        "kinesthetic": {
            "title": "Кинестетическая медитация любящей доброты",
            "content": """
            Устройтесь комфортно и поместите руки на сердце.
            Почувствуйте тепло рук и мягкое биение сердца под ними.

            Начните с направления любви к себе:
            Ощутите, как в груди растет теплое, мягкое чувство самопринятия.
            Позвольте этому теплу заполнить все тело.

            Представьте близкого человека и направьте это тепло к нему.
            Почувствуйте, как любовь течет из вашего сердца к его сердцу.

            Постепенно расширяйте это поле любви:
            - Ощутите связь с нейтральными людьми
            - Мягко коснитесь сердца сложных людей
            - Почувствуйте единство со всеми живыми существами

            Завершите, ощущая, как вся планета пульсирует в ритме одного большого сердца.
            """,
            "duration": "15-20 минут",
            "key_elements": ["физический контакт с сердцем", "ощущение тепла", "энергетические связи"],
            "difficulty": "продвинутый"
        }
    }
}


def get_meditation_adaptation_example(
    practice: str,
    modality: VAKModalityType,
    duration_preference: str = "standard",
    include_guidance_notes: bool = True
) -> Dict[str, Any]:
    """
    Получить пример адаптации медитативной практики под конкретную модальность.

    Args:
        practice: Название практики
        modality: Целевая модальность
        duration_preference: Предпочтение по длительности (short, standard, extended)
        include_guidance_notes: Включить заметки для инструкторов

    Returns:
        Словарь с примером адаптации
    """
    if practice not in MEDITATION_EXAMPLES:
        return {"error": f"Практика {practice} не найдена"}

    if modality.value not in MEDITATION_EXAMPLES[practice]:
        return {"error": f"Модальность {modality} не найдена для практики {practice}"}

    example = MEDITATION_EXAMPLES[practice][modality.value].copy()

    # Адаптация длительности
    duration_adjustments = {
        "short": 0.6,
        "standard": 1.0,
        "extended": 1.5
    }

    if duration_preference in duration_adjustments:
        multiplier = duration_adjustments[duration_preference]
        original_duration = example.get("duration", "10-15 минут")
        # Простая адаптация времени (в реальной системе было бы сложнее)
        example["adjusted_duration"] = f"Адаптировано для {duration_preference} сессии"

    if include_guidance_notes:
        guidance_notes = {
            VAKModalityType.VISUAL: [
                "Предложите участникам сидеть с открытыми глазами или используйте мягкий фокус",
                "Включите визуальные опоры: свечи, природные объекты, мандалы",
                "Говорите образами и используйте пространственные метафоры",
                "Предлагайте визуализации и работу с внутренними образами"
            ],
            VAKModalityType.AUDITORY: [
                "Обращайте особое внимание на тон голоса и темп речи",
                "Используйте ритмичные инструкции и повторения",
                "Включайте элементы мантр, звуков природы или тишины",
                "Предлагайте участникам проговаривание или внутренний диалог"
            ],
            VAKModalityType.KINESTHETIC: [
                "Уделите особое внимание позе и физическому комфорту",
                "Включайте осознанность дыхания и телесных ощущений",
                "Используйте тактильные элементы: подушки, пледы, четки",
                "Предлагайте медленные, осознанные движения"
            ]
        }
        example["guidance_notes"] = guidance_notes.get(modality, [])

    return example


def create_meditation_program_config(
    api_key: str,
    program_level: str = "beginner",
    session_duration: str = "standard",
    group_or_individual: str = "individual"
) -> Dict[str, Any]:
    """
    Создать конфигурацию для полной программы медитаций.

    Args:
        api_key: API ключ
        program_level: Уровень программы (beginner, intermediate, advanced)
        session_duration: Длительность сессий (short, standard, extended)
        group_or_individual: Формат (group, individual)

    Returns:
        Конфигурация программы медитаций
    """
    level_configs = {
        "beginner": {
            "practices": ["breath_awareness"],
            "complexity": "низкая",
            "guidance_level": "высокий",
            "recommended_sequence": 4
        },
        "intermediate": {
            "practices": ["breath_awareness", "body_scan"],
            "complexity": "средняя",
            "guidance_level": "средний",
            "recommended_sequence": 8
        },
        "advanced": {
            "practices": ["breath_awareness", "body_scan", "loving_kindness"],
            "complexity": "высокая",
            "guidance_level": "низкий",
            "recommended_sequence": 12
        }
    }

    base_config = create_meditation_config(api_key)
    level_config = level_configs.get(program_level, level_configs["beginner"])

    return {
        "dependencies": base_config,
        "program_level": program_level,
        "available_practices": level_config["practices"],
        "session_duration": session_duration,
        "format": group_or_individual,
        "total_sessions": level_config["recommended_sequence"],
        "adaptation_examples": {
            practice: {
                modality.value: get_meditation_adaptation_example(practice, modality)
                for modality in [VAKModalityType.VISUAL, VAKModalityType.AUDITORY, VAKModalityType.KINESTHETIC]
            }
            for practice in level_config["practices"]
        }
    }


# Предустановленные конфигурации
MEDITATION_THERAPY_CONFIG = {
    "name": "Медитация в терапии",
    "adaptation_depth": AdaptationDepth.DEEP,
    "trauma_sensitive": True,
    "recommended_practices": ["breath_awareness", "body_scan"],
    "avoid_practices": [],  # В терапии все практики можно адаптировать с осторожностью
    "special_considerations": [
        "Травма-информированный подход",
        "Особое внимание к триггерам",
        "Возможность прерывания практики",
        "Адаптация для тревожных состояний"
    ]
}

MEDITATION_WELLNESS_CONFIG = {
    "name": "Медитация для велнеса",
    "adaptation_depth": AdaptationDepth.MODERATE,
    "accessibility_focus": True,
    "recommended_practices": ["breath_awareness", "loving_kindness"],
    "group_friendly": True,
    "special_considerations": [
        "Адаптация для новичков",
        "Инклюзивность практик",
        "Светский подход",
        "Практическая применимость"
    ]
}

MEDITATION_CORPORATE_CONFIG = {
    "name": "Медитация в корпоративной среде",
    "adaptation_depth": AdaptationDepth.SURFACE,
    "time_efficient": True,
    "recommended_practices": ["breath_awareness"],
    "stress_reduction_focus": True,
    "special_considerations": [
        "Короткие сессии (5-10 минут)",
        "Фокус на продуктивности",
        "Светский подход",
        "Групповая применимость"
    ]
}