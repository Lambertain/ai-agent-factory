# -*- coding: utf-8 -*-
"""
–ü—Ä–∏–º–µ—Ä –∞–≥–µ–Ω—Ç–∞ —Å –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–º–∏ –∫–æ–ª–ª–µ–∫—Ç–∏–≤–Ω–æ–π —Ä–∞–±–æ—Ç—ã

–≠—Ç–æ—Ç —Ñ–∞–π–ª –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ—Ç:
- –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –∞–≥–µ–Ω—Ç–∞ —á–µ—Ä–µ–∑ create_universal_pydantic_agent
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ run_with_integrations –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π
- –°—Ç—Ä—É–∫—Ç—É—Ä—É dependencies —Å –ø–æ–ª—è–º–∏ –¥–ª—è RAG –∏ Archon
- –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ–∏–Ω–∞–ª—å–Ω—ã–µ —à–∞–≥–∏
"""

import os
from dataclasses import dataclass, field
from typing import List, Optional
from pydantic_ai import Agent, RunContext

# –ò–º–ø–æ—Ä—Ç—ã –¥–ª—è —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è –∞–≥–µ–Ω—Ç–∞
from .pydantic_ai_decorators import create_universal_pydantic_agent
from .pydantic_ai_integrations import run_with_integrations, execute_mandatory_final_steps


# ============================================================================
# DEPENDENCIES - –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∞–≥–µ–Ω—Ç–∞
# ============================================================================

@dataclass
class ExampleAgentDependencies:
    """
    –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –¥–ª—è –ø—Ä–∏–º–µ—Ä–∞ –∞–≥–µ–Ω—Ç–∞ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –∫–æ–ª–ª–µ–∫—Ç–∏–≤–Ω–æ–π —Ä–∞–±–æ—Ç—ã.

    –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–´–ï –ü–û–õ–Ø –¥–ª—è –∫–æ–ª–ª–µ–∫—Ç–∏–≤–Ω–æ–π —Ä–∞–±–æ—Ç—ã:
    - agent_name: –¥–ª—è –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –≤ —Å–∏—Å—Ç–µ–º–µ
    - archon_project_id: –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å Archon
    - knowledge_tags: –¥–ª—è –ø–æ–∏—Å–∫–∞ –≤ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π
    """

    # –û—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
    api_key: str
    project_path: str = ""

    # –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–´–ï –¥–ª—è –∫–æ–ª–ª–µ–∫—Ç–∏–≤–Ω–æ–π —Ä–∞–±–æ—Ç—ã
    agent_name: str = "example_agent"
    archon_project_id: str = "c75ef8e3-6f4d-4da2-9e81-8d38d04a341a"  # AI Agent Factory

    # RAG –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
    knowledge_tags: List[str] = field(default_factory=lambda: [
        "example-agent",
        "agent-knowledge",
        "pydantic-ai"
    ])
    knowledge_domain: Optional[str] = None

    def __post_init__(self):
        """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è dataclass."""
        if not self.knowledge_domain:
            self.knowledge_domain = "example.domain.com"


# ============================================================================
# SYSTEM PROMPT - –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –∞–≥–µ–Ω—Ç–∞
# ============================================================================

def get_system_prompt() -> str:
    """
    –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –∞–≥–µ–Ω—Ç–∞.

    –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –≤–∫–ª—é—á–∞–µ—Ç:
    - –û–ø–∏—Å–∞–Ω–∏–µ —ç–∫—Å–ø–µ—Ä—Ç–∏–∑—ã
    - –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é –∫–æ–ª–ª–µ–∫—Ç–∏–≤–Ω—ã—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
    - –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π —Ä–∞–±–æ—á–∏–π –ø—Ä–æ—Ü–µ—Å—Å
    """
    return """
–¢—ã Example Agent - —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ –∫–æ–ª–ª–µ–∫—Ç–∏–≤–Ω–æ–π —Ä–∞–±–æ—Ç—ã –∞–≥–µ–Ω—Ç–æ–≤.

## –¢–≤–æ—è —ç–∫—Å–ø–µ—Ä—Ç–∏–∑–∞:
- –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –∫–æ–ª–ª–µ–∫—Ç–∏–≤–Ω–æ–π —Ä–∞–±–æ—Ç—ã
- –†–∞–∑–±–∏–≤–∫–∞ –∑–∞–¥–∞—á –Ω–∞ –º–∏–∫—Ä–æ–∑–∞–¥–∞—á–∏
- –û—Ç—á–µ—Ç–Ω–æ—Å—Ç—å –æ –ø—Ä–æ–≥—Ä–µ—Å—Å–µ
- –†–µ—Ñ–ª–µ–∫—Å–∏—è –∏ —É–ª—É—á—à–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
- –î–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á –¥—Ä—É–≥–∏–º –∞–≥–µ–Ω—Ç–∞–º

## –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–´–ô —Ä–∞–±–æ—á–∏–π –ø—Ä–æ—Ü–µ—Å—Å:

### 1. –í –ù–ê–ß–ê–õ–ï –ö–ê–ñ–î–û–ô –ó–ê–î–ê–ß–ò:
- –ò—Å–ø–æ–ª—å–∑—É–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç break_down_to_microtasks() –¥–ª—è —Ä–∞–∑–±–∏–≤–∫–∏ –∑–∞–¥–∞—á–∏
- –ü–æ–∫–∞–∂–∏ –ø–ª–∞–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –ø–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º —Ä–∞–±–æ—Ç—ã
- –ü–æ–ª—É—á–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ (–≤ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–º —Ä–µ–∂–∏–º–µ —Å—á–∏—Ç–∞–µ—Ç—Å—è –æ–¥–æ–±—Ä–µ–Ω–Ω—ã–º)

### 2. –í–û –í–†–ï–ú–Ø –í–´–ü–û–õ–ù–ï–ù–ò–Ø:
- –ò—Å–ø–æ–ª—å–∑—É–π report_microtask_progress() –¥–ª—è –∫–∞–∂–¥–æ–π –º–∏–∫—Ä–æ–∑–∞–¥–∞—á–∏
- –í—ã–∑—ã–≤–∞–π check_delegation_need() –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
- –ï—Å–ª–∏ –Ω—É–∂–Ω–æ - –¥–µ–ª–µ–≥–∏—Ä—É–π —á–µ—Ä–µ–∑ delegate_task_to_agent()

### 3. –ü–ï–†–ï–î –ó–ê–í–ï–†–®–ï–ù–ò–ï–ú (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û):
- –ò—Å–ø–æ–ª—å–∑—É–π reflect_and_improve() –¥–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞
- –ù–∞–π–¥–∏ –º–∏–Ω–∏–º—É–º 2-3 –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –Ω–µ–¥–æ—Å—Ç–∞—Ç–∫–∞
- –£–ª—É—á—à–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø–µ—Ä–µ–¥ —Ñ–∏–Ω–∞–ª–∏–∑–∞—Ü–∏–µ–π

### 4. –§–ò–ù–ê–õ–ò–ó–ê–¶–ò–Ø:
- –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ —à–∞–≥–∏ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ run_with_integrations()
- Git –∫–æ–º–º–∏—Ç —Å–æ–∑–¥–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
- –°—Ç–∞—Ç—É—Å –≤ Archon –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

## –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Ç–µ–±–µ:
- break_down_to_microtasks(main_task, complexity_level)
- report_microtask_progress(microtask_number, description, status, details)
- reflect_and_improve(completed_work, work_type)
- check_delegation_need(current_task, current_agent_type)
- delegate_task_to_agent(target_agent, task_title, task_description, priority)
- search_agent_knowledge(query, match_count)

## –ü—Ä–∞–≤–∏–ª–∞:
1. –ù–ò–ö–û–ì–î–ê –Ω–µ –ø—Ä–æ–ø—É—Å–∫–∞–π —Ä–∞–∑–±–∏–≤–∫—É –Ω–∞ –º–∏–∫—Ä–æ–∑–∞–¥–∞—á–∏
2. –í–°–ï–ì–î–ê –æ—Ç—á–∏—Ç—ã–≤–∞–π—Å—è –æ –ø—Ä–æ–≥—Ä–µ—Å—Å–µ –∫–∞–∂–¥–æ–π –º–∏–∫—Ä–æ–∑–∞–¥–∞—á–∏
3. –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –ø—Ä–æ–≤–æ–¥–∏ —Ä–µ—Ñ–ª–µ–∫—Å–∏—é –ø–µ—Ä–µ–¥ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ–º
4. –î–µ–ª–µ–≥–∏—Ä—É–π –∑–∞–¥–∞—á–∏ –≤–Ω–µ —Ç–≤–æ–µ–π –∫–æ–º–ø–µ—Ç–µ–Ω—Ü–∏–∏

## –ö—Ä–∏—Ç–µ—Ä–∏–∏ –∫–∞—á–µ—Å—Ç–≤–∞:
- ‚úÖ –ü–ª–∞–Ω —Ä–∞–±–æ—Ç—ã –ø–æ–∫–∞–∑–∞–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
- ‚úÖ –ü—Ä–æ–≥—Ä–µ—Å—Å –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
- ‚úÖ –†–µ—Ñ–ª–µ–∫—Å–∏—è –ø—Ä–æ–≤–µ–¥–µ–Ω–∞ —Å –≤—ã—è–≤–ª–µ–Ω–∏–µ–º –Ω–µ–¥–æ—Å—Ç–∞—Ç–∫–æ–≤
- ‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç —É–ª—É—á—à–µ–Ω –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–µ—Ñ–ª–µ–∫—Å–∏–∏
- ‚úÖ –§–∏–Ω–∞–ª—å–Ω—ã–µ —à–∞–≥–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã (Git + Archon)
"""


# ============================================================================
# MODEL CONFIGURATION - –ù–∞—Å—Ç—Ä–æ–π–∫–∞ LLM –º–æ–¥–µ–ª–∏
# ============================================================================

def get_llm_model():
    """–ü–æ–ª—É—á–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–µ–Ω–Ω—É—é LLM –º–æ–¥–µ–ª—å."""
    from pydantic_ai.providers.openai import OpenAIProvider
    from pydantic_ai.models.openai import OpenAIModel

    api_key = os.getenv("LLM_API_KEY", "")
    base_url = os.getenv(
        "LLM_BASE_URL",
        "https://dashscope.aliyuncs.com/compatible-mode/v1"
    )
    model_name = os.getenv("LLM_MODEL", "qwen2.5-coder-32b-instruct")

    provider = OpenAIProvider(base_url=base_url, api_key=api_key)
    return OpenAIModel(model_name, provider=provider)


# ============================================================================
# AGENT CREATION - –°–æ–∑–¥–∞–Ω–∏–µ –∞–≥–µ–Ω—Ç–∞
# ============================================================================

# –°–æ–∑–¥–∞–µ–º –∞–≥–µ–Ω—Ç–∞ —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º–∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è–º–∏
example_agent = create_universal_pydantic_agent(
    model=get_llm_model(),
    deps_type=ExampleAgentDependencies,
    system_prompt=get_system_prompt(),
    agent_type="example_agent",
    knowledge_tags=["example-agent", "agent-knowledge", "pydantic-ai"],
    knowledge_domain="example.domain.com",
    with_collective_tools=True,  # ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è–µ—Ç –∫–æ–ª–ª–µ–∫—Ç–∏–≤–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã
    with_knowledge_tool=True     # ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è–µ—Ç –ø–æ–∏—Å–∫ –≤ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π
)


# ============================================================================
# CUSTOM TOOLS - –°–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –∞–≥–µ–Ω—Ç–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
# ============================================================================

@example_agent.tool
async def example_specific_tool(
    ctx: RunContext[ExampleAgentDependencies],
    parameter: str
) -> str:
    """
    –ü—Ä–∏–º–µ—Ä —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω–æ–≥–æ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ –∞–≥–µ–Ω—Ç–∞.

    –î–æ–±–∞–≤–ª—è–µ—Ç—Å—è –∫ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º –∫–æ–ª–ª–µ–∫—Ç–∏–≤–Ω—ã–º –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–º.

    Args:
        ctx: –ö–æ–Ω—Ç–µ–∫—Å—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
        parameter: –ö–∞–∫–æ–π-—Ç–æ –ø–∞—Ä–∞–º–µ—Ç—Ä

    Returns:
        –†–µ–∑—É–ª—å—Ç–∞—Ç —Ä–∞–±–æ—Ç—ã –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞
    """
    return f"–í—ã–ø–æ–ª–Ω–µ–Ω —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º: {parameter}"


# ============================================================================
# RUNNER FUNCTION - –§—É–Ω–∫—Ü–∏—è –∑–∞–ø—É—Å–∫–∞ –∞–≥–µ–Ω—Ç–∞
# ============================================================================

async def run_example_agent(
    user_message: str,
    api_key: str,
    project_path: str = "",
    archon_task_id: Optional[str] = None
) -> str:
    """
    –ó–∞–ø—É—Å—Ç–∏—Ç—å Example Agent —Å –ø–æ–ª–Ω—ã–º–∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è–º–∏.

    –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Å–ø–æ—Å–æ–± –∑–∞–ø—É—Å–∫–∞ –∞–≥–µ–Ω—Ç–∞ —Å:
    - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π —Ä–∞–∑–±–∏–≤–∫–æ–π –Ω–∞ –º–∏–∫—Ä–æ–∑–∞–¥–∞—á–∏
    - –û—Ç—á–µ—Ç–Ω–æ—Å—Ç—å—é –æ –ø—Ä–æ–≥—Ä–µ—Å—Å–µ
    - –ü—Ä–æ–≤–µ—Ä–∫–æ–π –¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
    - –†–µ—Ñ–ª–µ–∫—Å–∏–µ–π –∏ —É–ª—É—á—à–µ–Ω–∏–µ–º
    - –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–º–∏ —Ñ–∏–Ω–∞–ª—å–Ω—ã–º–∏ —à–∞–≥–∞–º–∏ (Git + Archon)

    Args:
        user_message: –°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        api_key: API –∫–ª—é—á –¥–ª—è LLM
        project_path: –ü—É—Ç—å –∫ –ø—Ä–æ–µ–∫—Ç—É (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
        archon_task_id: ID –∑–∞–¥–∞—á–∏ –≤ Archon (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

    Returns:
        –†–µ–∑—É–ª—å—Ç–∞—Ç —Ä–∞–±–æ—Ç—ã –∞–≥–µ–Ω—Ç–∞ —Å –ø—Ä–∏–º–µ–Ω–µ–Ω–Ω—ã–º–∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è–º–∏

    Example:
        >>> result = await run_example_agent(
        ...     user_message="–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è –∫–æ–ª–ª–µ–∫—Ç–∏–≤–Ω–æ–π —Ä–∞–±–æ—Ç—ã",
        ...     api_key=os.getenv("LLM_API_KEY"),
        ...     archon_task_id="task-123"
        ... )
    """

    # –°–æ–∑–¥–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
    deps = ExampleAgentDependencies(
        api_key=api_key,
        project_path=project_path
    )

    # ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–´–ô –°–ü–û–°–û–ë: –ò—Å–ø–æ–ª—å–∑—É–µ–º run_with_integrations
    # –≠—Ç–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏–º–µ–Ω—è–µ—Ç –í–°–ï –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏:
    # - –†–∞–∑–±–∏–≤–∫–∞ –Ω–∞ –º–∏–∫—Ä–æ–∑–∞–¥–∞—á–∏ (–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é)
    # - –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
    # - –û—Ç—á–µ—Ç–Ω–æ—Å—Ç—å –æ –ø—Ä–æ–≥—Ä–µ—Å—Å–µ
    # - –†–µ—Ñ–ª–µ–∫—Å–∏—è –∏ —É–ª—É—á—à–µ–Ω–∏–µ
    # - Git –∫–æ–º–º–∏—Ç
    # - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ Archon

    result = await run_with_integrations(
        agent=example_agent,
        user_message=user_message,
        deps=deps,
        agent_type="example_agent"
    )

    # –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ–∏–Ω–∞–ª—å–Ω—ã–µ —à–∞–≥–∏ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ –≤—Ä—É—á–Ω—É—é)
    # –û–±—ã—á–Ω–æ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ run_with_integrations,
    # –Ω–æ –º–æ–∂–Ω–æ –≤—ã–∑–≤–∞—Ç—å –≤—Ä—É—á–Ω—É—é –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ –∫–æ–Ω—Ç—Ä–æ–ª—è:

    if archon_task_id:
        final_report = await execute_mandatory_final_steps(
            task_description=user_message,
            agent_type="example_agent",
            task_id=archon_task_id,
            task_status="done",
            notes=f"–†–µ–∑—É–ª—å—Ç–∞—Ç: {result[:100]}..."
        )
        print("\n" + "="*60)
        print(final_report)
        print("="*60 + "\n")

    return result


# ============================================================================
# –ê–õ–¨–¢–ï–†–ù–ê–¢–ò–í–ù–´–ô –°–ü–û–°–û–ë - –†—É—á–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
# ============================================================================

async def run_example_agent_manual(
    user_message: str,
    api_key: str,
    archon_task_id: Optional[str] = None
) -> str:
    """
    –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Å–ø–æ—Å–æ–± –∑–∞–ø—É—Å–∫–∞ —Å —Ä—É—á–Ω—ã–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤.

    ‚ö†Ô∏è –ù–ï –†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø –¥–ª—è –æ–±—ã—á–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è.
    –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ run_with_integrations –≤–º–µ—Å—Ç–æ —ç—Ç–æ–≥–æ.

    –≠—Ç–æ—Ç —Å–ø–æ—Å–æ–± –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ—Ç —á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç "–ø–æ–¥ –∫–∞–ø–æ—Ç–æ–º".
    """

    from .collective_work_tools import (
        break_down_to_microtasks,
        report_microtask_progress,
        reflect_and_improve,
        check_delegation_need
    )

    deps = ExampleAgentDependencies(api_key=api_key)

    # –°–æ–∑–¥–∞–µ–º —Ñ–µ–π–∫–æ–≤—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏
    class FakeContext:
        def __init__(self, deps):
            self.deps = deps

    ctx = FakeContext(deps)

    # 1. –†–∞–∑–±–∏–≤–∫–∞ –Ω–∞ –º–∏–∫—Ä–æ–∑–∞–¥–∞—á–∏
    print("\nüîπ –®–ê–ì 1: –†–∞–∑–±–∏–≤–∫–∞ –Ω–∞ –º–∏–∫—Ä–æ–∑–∞–¥–∞—á–∏")
    microtasks_plan = await break_down_to_microtasks(
        ctx, user_message, complexity_level="medium"
    )
    print(microtasks_plan)

    # 2. –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Å –æ—Ç—á–µ—Ç–Ω–æ—Å—Ç—å—é
    print("\nüîπ –®–ê–ì 2: –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –º–∏–∫—Ä–æ–∑–∞–¥–∞—á")
    progress_1 = await report_microtask_progress(
        ctx, 1, "–ê–Ω–∞–ª–∏–∑ –∑–∞–¥–∞—á–∏", "completed", "–ó–∞–¥–∞—á–∞ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞"
    )
    print(progress_1)

    # 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
    print("\nüîπ –®–ê–ì 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏—è")
    delegation_check = await check_delegation_need(
        ctx, user_message, "example_agent"
    )
    print(delegation_check)

    # 4. –û—Å–Ω–æ–≤–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
    print("\nüîπ –®–ê–ì 4: –û—Å–Ω–æ–≤–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ")
    result = await example_agent.run(user_message, deps=deps)
    agent_response = result.data

    # 5. –†–µ—Ñ–ª–µ–∫—Å–∏—è
    print("\nüîπ –®–ê–ì 5: –†–µ—Ñ–ª–µ–∫—Å–∏—è –∏ —É–ª—É—á—à–µ–Ω–∏–µ")
    reflection = await reflect_and_improve(
        ctx, agent_response, work_type="implementation"
    )
    print(reflection)

    # 6. –§–∏–Ω–∞–ª—å–Ω—ã–µ —à–∞–≥–∏
    if archon_task_id:
        print("\nüîπ –®–ê–ì 6: –§–∏–Ω–∞–ª—å–Ω—ã–µ —à–∞–≥–∏")
        final_report = await execute_mandatory_final_steps(
            task_description=user_message,
            agent_type="example_agent",
            task_id=archon_task_id,
            task_status="done"
        )
        print(final_report)

    return agent_response


# ============================================================================
# QUICK START FUNCTION - –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
# ============================================================================

async def quick_start_example():
    """
    –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∞–≥–µ–Ω—Ç–∞.

    –î–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ—Ç –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –∫–æ–¥ –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –∞–≥–µ–Ω—Ç–∞ —Å –∫–æ–ª–ª–µ–∫—Ç–∏–≤–Ω—ã–º–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–º–∏.
    """
    import os
    from dotenv import load_dotenv

    # –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
    load_dotenv()

    api_key = os.getenv("LLM_API_KEY")
    if not api_key:
        print("‚ùå –û—à–∏–±–∫–∞: LLM_API_KEY –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è")
        return

    # –ó–∞–ø—É—Å–∫–∞–µ–º –∞–≥–µ–Ω—Ç–∞
    result = await run_example_agent(
        user_message="–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —Ä–∞–±–æ—Ç—ã –∫–æ–ª–ª–µ–∫—Ç–∏–≤–Ω—ã—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤",
        api_key=api_key
    )

    print("\n" + "="*60)
    print("–†–ï–ó–£–õ–¨–¢–ê–¢ –†–ê–ë–û–¢–´ –ê–ì–ï–ù–¢–ê:")
    print("="*60)
    print(result)
    print("="*60)


# ============================================================================
# EXPORTS
# ============================================================================

__all__ = [
    "example_agent",
    "run_example_agent",
    "run_example_agent_manual",
    "quick_start_example",
    "ExampleAgentDependencies"
]


# ============================================================================
# USAGE EXAMPLES
# ============================================================================

"""
–ü–†–ò–ú–ï–† 1: –ë–∞–∑–æ–≤–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

```python
import asyncio
from agents.common.EXAMPLE_AGENT_WITH_COLLECTIVE_TOOLS import run_example_agent

async def main():
    result = await run_example_agent(
        user_message="–¢–≤–æ—è –∑–∞–¥–∞—á–∞",
        api_key="your_api_key"
    )
    print(result)

asyncio.run(main())
```

–ü–†–ò–ú–ï–† 2: –° Archon task ID

```python
result = await run_example_agent(
    user_message="–¢–≤–æ—è –∑–∞–¥–∞—á–∞",
    api_key="your_api_key",
    archon_task_id="f5250349-9315-46d0-9969-760f3018f6e5"
)
```

–ü–†–ò–ú–ï–† 3: –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

```python
from agents.common.EXAMPLE_AGENT_WITH_COLLECTIVE_TOOLS import quick_start_example
import asyncio

asyncio.run(quick_start_example())
```

–ü–†–ò–ú–ï–† 4: –°–æ–∑–¥–∞–Ω–∏–µ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∞–≥–µ–Ω—Ç–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ —ç—Ç–æ–≥–æ –ø—Ä–∏–º–µ—Ä–∞

1. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —ç—Ç–æ—Ç —Ñ–∞–π–ª –≤ –≤–∞—à—É –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –∞–≥–µ–Ω—Ç–∞
2. –ü–µ—Ä–µ–∏–º–µ–Ω—É–π—Ç–µ –∫–ª–∞—Å—Å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π: ExampleAgentDependencies ‚Üí YourAgentDependencies
3. –û–±–Ω–æ–≤–∏—Ç–µ system_prompt —Å –≤–∞—à–µ–π —ç–∫—Å–ø–µ—Ä—Ç–∏–∑–æ–π
4. –î–æ–±–∞–≤—å—Ç–µ —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã —á–µ—Ä–µ–∑ @agent.tool
5. –û–±–Ω–æ–≤–∏—Ç–µ knowledge_tags –∏ agent_type
6. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ run_with_integrations –¥–ª—è –∑–∞–ø—É—Å–∫–∞

–í—Å–µ –∫–æ–ª–ª–µ–∫—Ç–∏–≤–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –±—É–¥—É—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏!
"""
