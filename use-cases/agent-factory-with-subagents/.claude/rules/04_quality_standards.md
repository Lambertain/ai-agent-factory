# 04. Стандарти якості

## 🚨 КРИТИЧНО ВАЖЛИВО: ЗАПРЕТ ТОКЕН-ЭКОНОМИИ И МАССОВЫХ ОПЕРАЦИЙ

**🔴 ЧИТАЙ ДЕТАЛЬНО:** `.claude/rules/08_no_shortcuts.md`

**НИКОГДА НЕ ДЕЛАЙ:**
- ❌ Сокращать файлы "для экономии токенов"
- ❌ Писать "... (остальной код без изменений)"
- ❌ Пропускать комментарии и документацию
- ❌ Обрабатывать файлы "массово" без тщательной проверки
- ❌ Делать задачи "быстро" за счет качества
- ❌ Обходить проблемы вместо их решения (закомитить с ошибками, удалить код, упростить)
- ❌ Игнорировать ошибки TypeScript/ESLint/Tests

**ОБЯЗАТЕЛЬНО ДЕЛАЙ:**
- ✅ Пиши ПОЛНЫЙ код с ВСЕМИ комментариями
- ✅ Если файл большой - пиши его ЧАСТЯМИ, но полностью
- ✅ Обрабатывай КАЖДЫЙ файл тщательно и индивидуально
- ✅ Проверяй КАЖДОЕ изменение перед следующим
- ✅ Документируй КАЖДУЮ функцию и класс
- ✅ РЕШАЙ проблемы, а не обходи их
- ✅ Исправляй ВСЕ ошибки (ZERO TOLERANCE)

**ПРАВИЛО БОЛЬШИХ ФАЙЛОВ:**
Если файл превышает лимит токенов:
1. Разбей на логические секции
2. Пиши каждую секцию полностью
3. Не используй "..." или сокращения
4. Сохраняй ВСЕ комментарии

**КАЧЕСТВО > СКОРОСТЬ**

---

## 🌐 КРИТИЧНО ВАЖЛИВО: ПРИНЦИП УНІВЕРСАЛЬНОСТІ АГЕНТІВ

**ВСІ АГЕНТИ ПОВИННІ БУТИ УНІВЕРСАЛЬНИМИ!**

### ❌ ЗАБОРОНЕНО:

- Жорсткі прив'язки до конкретних проектів (UniPark, etc.)
- Hardcoded кольорові палітри або брендинг
- Фіксовані схеми даних
- Проект-специфічні промпти
- Неконфігуровні залежності
- Згадки конкретних компаній або продуктів у коді

### ✅ ОБОВ'ЯЗКОВО:

- Конфігуровані налаштування проекту через environment variables
- Динамічні кольорові схеми через налаштування
- Адаптивні промпти під різні технології та домени
- Examples/ папка з конфігураціями для різних доменів
- Універсальна документація в README з прикладами для різних use cases
- Налаштовувані залежності через dataclass з полями domain_type, project_type
- Підтримка multiple frameworks/technologies в одному агенті

### 🔍 КРИТЕРІЇ УНІВЕРСАЛЬНОСТІ:

- Агент працює з будь-яким проектом даного типу
- 0% згадок конкретних проектів у коді та промптах
- ≥3 приклади конфігурацій для різних доменів
- Повна адаптованість через налаштування

## 📏 СТАНДАРТИ МОДУЛЬНОСТІ

### 1️⃣ ПРАВИЛО РОЗМІРУ ФАЙЛІВ

**НІКОЛИ не створювати файл довше 500 рядків коду!**

Якщо файл наближається до цього ліміту:
- Розбивай на модулі або допоміжні файли
- Групуй код за функціональністю
- Виноси загальну логіку в окремі файли

**Приклад правильної структури:**
```
agent/
├── agent.py (200 рядків) - основна логіка агента
├── tools.py (300 рядків) - інструменти
├── prompts.py (150 рядків) - системні промпти
├── settings.py (100 рядків) - конфігурація
├── providers.py (80 рядків) - провайдери моделей
└── dependencies.py (200 рядків) - залежності
```

### 2️⃣ ПРАВИЛО МОДУЛЬНОЇ ОРГАНІЗАЦІЇ

**Організовуй код у чітко розділені модулі:**

Для агентів це виглядає так:
- `agent.py` - Головне визначення агента та логіка виконання
- `tools.py` - Функції-інструменти, що використовуються агентом
- `prompts.py` - Системні промпти
- `settings.py` - Конфігурація та налаштування
- `dependencies.py` - Залежності агента
- `providers.py` - Провайдери LLM моделей

## 🔄 ПРАВИЛО ТРЬОХЕТАПНОГО ВИКОНАННЯ

**Кожна задача ПОВИННА проходити 3 етапи:**

### ЕТАП 1: ВИКОНАННЯ
- Реалізація основної функціональності
- Дотримання всіх вимог
- Створення необхідних файлів та коду

### ЕТАП 2: РЕФЛЕКСІЯ ТА КРИТИЧНИЙ АНАЛІЗ

**НІКОЛИ НЕ ЗАВЕРШУЙ ЗАДАЧУ БЕЗ РЕФЛЕКСІЇ!**

```python
# ПЕРЕД ЗАКРИТТЯМ КОЖНОЇ ЗАДАЧІ виконуй розширений цикл рефлексії:
1. Критичний аналіз виконаної роботи
2. Виявлення мінімум 2-3 конкретних недоліків
3. Пропозиція конкретних покращень
4. Перевірка відповідності всім критеріям якості
```

**ОБОВ'ЯЗКОВА СТРУКТУРА РЕФЛЕКСІЇ:**

```markdown
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🔍 РЕФЛЕКСІЯ ТА КРИТИЧНИЙ АНАЛІЗ
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

✅ Що зроблено добре:
• [конкретний позитив 1]
• [конкретний позитив 2]

❌ Виявлені недоліки:
• [конкретний недолік 1]
• [конкретний недолік 2]

💡 Запропоновані покращення:
1. [конкретне покращення 1 з описом]
2. [конкретне покращення 2 з описом]

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
❓ Вносити запропоновані покращення? (так/ні)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

### ЕТАП 3: ПІДТВЕРДЖЕННЯ КОРИСТУВАЧА ТА ПОКРАЩЕННЯ

**🚨 КРИТИЧНО ВАЖЛИВО: ОБОВ'ЯЗКОВО ЗАПИТАТИ ДОЗВІЛ!**

**АЛГОРИТМ ПІСЛЯ РЕФЛЕКСІЇ:**

```python
async def reflection_workflow():
    """Обов'язковий workflow після рефлексії."""

    # 1. Провести критичний аналіз
    analysis = await perform_critical_analysis()

    # 2. Вивести рефлексію користувачу (обов'язковий шаблон)
    print_reflection_template(analysis)

    # 3. 🚨 ЗАПИТАТИ ДОЗВІЛ
    print("❓ Вносити запропоновані покращення? (так/ні)")

    # 4. ЗУПИНИТИСЯ - чекати відповіді
    # ЗАБОРОНЕНО продовжувати без дозволу!

    # 5. Тільки ПІСЛЯ відповіді:
    if user_response == "так":
        await apply_improvements(analysis.improvements)
        print("✅ Покращення застосовані")
    else:
        print("⏭️ Покращення пропущені, продовжуємо")

    # 6. Тільки ПІСЛЯ цього - git коміт та наступні кроки
```

**❌ ЗАБОРОНЕНІ ПАТТЕРНИ:**

```
❌ НЕПРАВИЛЬНО:
"Провів рефлексію. Виявив проблеми A, B, C.
Наступна задача: ..."

✅ ПРАВИЛЬНО:
"Провів рефлексію. Виявив проблеми A, B, C.
Запропоновані покращення: 1) ..., 2) ...
❓ Вносити запропоновані покращення? (так/ні)"
[ЧЕКАТИ ВІДПОВІДІ]
```

**РЕФЛЕКСІЯ ПОВИННА БУТИ ВИДИМОЮ:**
- Обов'язково описувати знайдені проблеми
- Показувати запропоновані покращення
- **ЧЕКАТИ ПІДТВЕРДЖЕННЯ КОРИСТУВАЧА**
- Застосовувати покращення тільки після дозволу
- Демонструвати кінцевий результат

---

## 📝 ПРАКТИЧНИЙ ПРИКЛАД ПОВНОГО WORKFLOW

**Сценарій: Виконання задачі "Створити Payment Integration Agent"**

```markdown
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📌 PROJECT CONTEXT: AI Agent Factory (ID: c75ef8e3-6f4d-4da2-9e81-8d38d04a341a)
🎭 ROLE: Archon Implementation Engineer
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

### КРОК 1: ОТРИМАННЯ ЗАДАЧІ

Отримав задачу: "Створити Payment Integration Agent"
Task ID: task-123
Project ID: c75ef8e3-6f4d-4da2-9e81-8d38d04a341a

### КРОК 2: ПЕРЕКЛЮЧЕННЯ В РОЛЬ

🔍 Шукаю промпт ролі Implementation Engineer...
📁 Знайдений файл: agents/archon_implementation_engineer/knowledge/...
📖 Читаю системний промпт ролі...

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🎭 ПЕРЕКЛЮЧАЮСЯ В РОЛЬ ARCHON IMPLEMENTATION ENGINEER
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

📋 Моя експертиза:
• Розробка універсальних агентів на Pydantic AI
• Реалізація інструментів та dependencies
• Модульна архітектура (файли <500 рядків)
• Python best practices та type hints

✅ Готовий виконати задачу в ролі Implementation Engineer

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

### КРОК 3: СТВОРЕННЯ МІКРОЗАДАЧ (TodoWrite)

[TodoWrite створено з 5 мікрозадачами]

1. Створити структуру файлів агента
2. Реалізувати agent.py з основною логікою
3. Створити tools.py з платіжними інструментами
4. Рефлексія та критичний аналіз результатів
5. Git коміт із змінами

### КРОКИ 4-6: ВИКОНАННЯ МІКРОЗАДАЧ

✅ Виконано: Створена структура файлів
✅ Виконано: Реалізований agent.py (142 рядки)
✅ Виконано: Створений tools.py (189 рядків)

### КРОК 7: РЕФЛЕКСІЯ (ОБОВ'ЯЗКОВО)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🔍 РЕФЛЕКСІЯ ТА КРИТИЧНИЙ АНАЛІЗ
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

✅ Що зроблено добре:
• Створена універсальна структура без hardcoded значень
• Всі файли менше 500 рядків
• Використані type hints та docstrings
• Dependencies через dataclass

❌ Виявлені недоліки:
• У tools.py дублюється логіка валідації payment_data
• Відсутній unit тест для refund функції
• Не додана обробка timeout для Stripe API

💡 Запропоновані покращення:
1. Рефакторинг валідації: Винести validate_payment_data в validators.py
2. Додати тести: test_process_refund з 3 сценаріями
3. Timeout handling: Додати retry з exponential backoff

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
❓ Вносити запропоновані покращення? (так/ні)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

[ЗУПИНКА - ЧЕКАЮ ВІДПОВІДІ КОРИСТУВАЧА]
```

**Користувач відповідає: "так"**

```markdown
✅ Покращення застосовані

### КРОК 8: ЗАСТОСУВАННЯ ПОКРАЩЕНЬ

✅ Створений validators.py з validate_payment_data
✅ Додані unit тести test_process_refund.py
✅ Реалізований retry mechanism з exponential backoff

📊 Результат після покращень:
- tools.py: 189 → 156 рядків (винесена валідація)
- validators.py: 45 рядків (нова)
- tests/test_process_refund.py: 38 рядків (нова)
- Покриття тестами: 85%

### КРОК 9: GIT КОМІТ

```bash
git add .
git commit -m "feat(agents): додано Payment Integration Agent

- Універсальна структура для платіжних систем
- Підтримка Stripe, PayPal через конфігурацію
- Unit тести з 85% покриттям
- Retry механізм для API calls
- Модульність: всі файли <500 рядків

🤖 Generated with Claude Code
Co-Authored-By: Claude <noreply@anthropic.com>"
```

✅ Коміт створено

### КРОК 10: ОНОВЛЕННЯ СТАТУСУ В ARCHON

[Оновлено статус задачі на "done"]

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
✅ Задача завершена: Створити Payment Integration Agent
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

### КРОК 11: ПЕРЕКЛЮЧЕННЯ НА PROJECT MANAGER

🎭 ПЕРЕКЛЮЧАЮСЯ НА РОЛЬ ARCHON PROJECT MANAGER

📌 PROJECT CONTEXT: AI Agent Factory (ID: c75ef8e3-6f4d-4da2-9e81-8d38d04a341a)
🎭 ROLE: Archon Project Manager

🔍 Шукаю наступну задачу з найвищим пріоритетом...

[Викликаю mcp__archon__find_tasks з project_id для збереження контексту]

📋 Наступна задача: "Створити Queue Worker Agent" (пріоритет P1-High, task_order: 95)

▶️ Переключаюся в роль Implementation Engineer для виконання...
```

---

## ✅ КОНТРОЛЬНИЙ ЧЕК-ЛИСТ ПЕРЕД ЗАВЕРШЕННЯМ ЗАДАЧІ

**ОБОВ'ЯЗКОВО ПЕРЕВІР ПЕРЕД GIT КОММІТОМ:**

```markdown
### 📋 Чек-лист завершення задачі

**Переключення та контекст:**
- [ ] ✅ Переключився в роль перед виконанням
- [ ] ✅ Створив мікрозадачі через TodoWrite
- [ ] ✅ Включив `📌 PROJECT CONTEXT: [title] (ID: [project_id])` у відповідь

**Виконання:**
- [ ] ✅ Виконав всі мікрозадачі по черзі
- [ ] ✅ Універсальність: 0% hardcoded проект-специфічного коду
- [ ] ✅ Модульність: всі файли <500 рядків

**Рефлексія (КРИТИЧНО):**
- [ ] ✅ Провів критичний аналіз
- [ ] ✅ Знайшов мінімум 2-3 недоліки
- [ ] ✅ Запропонував конкретні покращення
- [ ] 🚨 **ЗАПИТАВ: "Вносити покращення? (так/ні)"**
- [ ] 🚨 **ЗУПИНИВСЯ і чекав відповіді**

**Після підтвердження:**
- [ ] ✅ Застосував покращення (якщо "так") або пропустив (якщо "ні")
- [ ] ✅ Створив git коміт з описом
- [ ] ✅ Оновив статус задачі в Archon

**Наступні кроки:**
- [ ] ✅ Переключився на проджект-менеджера
- [ ] ✅ Викликав find_tasks з project_id (збереження контексту)
- [ ] ✅ Знайшов наступну задачу з найвищим пріоритетом
```

**🔴 ЧЕРВОНІ ЛІНІЇ - ЗАБОРОНЕНО ЗАВЕРШУВАТИ ЯКЩО:**
- ❌ Не провів рефлексію
- ❌ Не запитав підтвердження користувача
- ❌ Застосував покращення без дозволу
- ❌ Немає project_id у header відповіді
- ❌ Є файли >500 рядків
- ❌ Немає git коміту
- ❌ Статус в Archon не оновлений

---

## 🎯 ЧЕКЛІСТ ЯКОСТІ АГЕНТА

**КОЖЕН АГЕНТ ПОВИНЕН ПРОЙТИ ПЕРЕВІРКУ:**

- [ ] ❌ **0% згадок конкретних проектів** у коді, промптах, коментарях
- [ ] ✅ **Конфігурованість** через domain_type, project_type, framework
- [ ] ✅ **≥3 приклади конфігурацій** у examples/ для різних доменів
- [ ] ✅ **Адаптивні промпти** під різні технології
- [ ] ✅ **Універсальна документація** з прикладами для різних use cases
- [ ] ✅ **Модульність** - файли до 500 рядків
- [ ] ✅ **Повне тестування** - всі функції покриті тестами
- [ ] ✅ **Документація** - README з прикладами використання
- [ ] ✅ **База знань** - файл knowledge/ з системним промптом

**ЯКЩО АГЕНТ НЕ ВІДПОВІДАЄ ЦИМ КРИТЕРІЯМ** - він повинен бути відхилений та переоблений до повної універсальності.

## 📚 ПРАВИЛО БАЗ ЗНАНЬ

**Кожен спеціалізований агент ПОВИНЕН мати власну базу знань:**

### Процес створення агента з знаннями:

1. **СПОЧАТКУ** - перевірити RAG на наявність знань
2. **ПОТІМ** - створити файл знань одразу в правильному місці
3. **НАДАТИ ІНФОРМАЦІЮ КОРИСТУВАЧУ** про файли та теги
4. **ПОТІМ** - завантажити в Archon Knowledge Base
5. **ПРИВ'ЯЗАТИ** до проекту AI Agent Factory

**Структура файлу знань:**
```
agents/[agent_name]/knowledge/[agent_name]_knowledge.md
```

**Обов'язкові теги:**
- `[agent_name]` - ім'я агента
- `agent-knowledge` - маркер знань агента
- `pydantic-ai` - фреймворк
- `[domain]` - область експертизи

## 🔄 ПРАВИЛО ПОСЛІДОВНОСТІ СТВОРЕННЯ

**КРИТИЧНА ПОСЛІДОВНІСТЬ при створенні агентів:**

1. **СПОЧАТКУ** - створюй ВСІ файли знань для всіх агентів проекту
2. **ПОТІМ** - створюй самих агентів (agent.py, tools.py тощо)
3. Агенти повинні посилатися на вже існуючі бази знань

**Можна створювати кілька файлів знань за один раз для групи агентів**
