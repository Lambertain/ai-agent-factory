# 01. Правила переключення в роль експерта

## ⚠️ КРИТИЧНО ВАЖЛИВО: ОБОВ'ЯЗКОВЕ ПЕРЕКЛЮЧЕННЯ В РОЛЬ

**🚨 ЖОДНА ЗАДАЧА НЕ ВИКОНУЄТЬСЯ БЕЗ ПЕРЕКЛЮЧЕННЯ В РОЛЬ!**

### 📋 Обов'язковий алгоритм ПЕРЕД будь-якою задачею:

```
ЕТАП 1: ПОШУК І ЧИТАННЯ ПРОМПТУ (1-2 хвилини)
├─ 1️⃣ Визначити роль з контексту задачі
├─ 2️⃣ Знайти промпт: Glob(**/*[ключове_слово]*knowledge*.md)
├─ 3️⃣ Прочитати системний промпт ролі
└─ 4️⃣ Вилучити ключові компетенції

ЕТАП 1.5: ПЕРЕВІРКА МОДУЛЬНОЇ СТРУКТУРИ (ОБОВ'ЯЗКОВО)
├─ 5️⃣ Перевірити наявність module_selection.md в knowledge/
│   └─ Glob(**/*[ключове_слово]*module_selection*.md)
├─ 6️⃣ ЯКЩО знайдено → прочитати module_selection.md
├─ 7️⃣ Використати keyword matching для вибору релевантних модулів
├─ 8️⃣ Прочитати ТІЛЬКИ вибрані модулі (НЕ всі)
└─ 9️⃣ ЯКЩО не знайдено → перейти до ЕТАПУ 1.6

**КРИТИЧНО:**
- Модульна архітектура = токен-економія 57%
- НЕ читати ВСІ модулі - ТІЛЬКИ релевантні для задачі
- Повідомити користувача: "📚 Обрано модулі: [список]"

ЕТАП 1.6: АВТОМАТИЧНА ЗАДАЧА РЕФАКТОРИНГУ (якщо НЕ знайдено)
├─ Повідомити: "⚠️ Агент [назва] НЕ рефакторений в модульну структуру. Створюю задачу для Blueprint Architect..."
├─ АВТОМАТИЧНО створити задачу:
│   • mcp__archon__manage_task("create",
│       project_id="[поточний project_id]",
│       assignee="Blueprint Architect",
│       title="Рефакторинг [agent_name]: створити модульну структуру",
│       description="Створити module_selection.md та розбити knowledge на модулі для токен-економії 57%",
│       status="todo")
└─ Продовжити роботу з main knowledge.md (старий workflow)

**ПРИКЛАДИ ПОШУКУ module_selection.md:**

```python
# Для Blueprint Architect:
Glob(path="D:\\Automation\\agent-factory\\use-cases\\agent-factory-with-subagents\\agents",
     pattern="**/archon_blueprint_architect/*module_selection*.md")

# Для будь-якого агента (загальний патерн):
Glob(path="...\\agents",
     pattern="**/*[назва_агента]*module_selection*.md")

# Приклад для UIUX Enhancement Agent:
Glob(pattern="**/uiux*module_selection*.md")
```

**ПРАВИЛА ВИЛУЧЕННЯ КЛЮЧОВОГО СЛОВА:**

1. **Для агентів з префіксом "archon_"** - використовувати ПОВНИЙ префікс:
   - ✅ `archon_blueprint_architect` → ключове слово: `archon_blueprint`
   - ✅ `archon_implementation_engineer` → ключове слово: `archon_implementation`
   - ✅ `archon_project_manager` → ключове слово: `archon_project`
   - ❌ НЕ використовувати тільки `blueprint`, `implementation`, `project`

2. **Для агентів БЕЗ префіксу "archon_"** - використовувати перше значуще слово:
   - ✅ `deployment_engineer` → ключове слово: `deployment`
   - ✅ `uiux_enhancement_agent` → ключове слово: `uiux`
   - ✅ `typescript_architecture_agent` → ключове слово: `typescript`

**ТАБЛИЦЯ ПРИКЛАДІВ:**

| Назва агента | Ключове слово | Glob патерн | Коментар |
|--------------|---------------|-------------|----------|
| archon_blueprint_architect | `archon_blueprint` | `**/archon_blueprint*module_selection*.md` | З префіксом archon_ |
| archon_implementation_engineer | `archon_implementation` | `**/archon_implementation*module_selection*.md` | З префіксом archon_ |
| archon_project_manager | `archon_project` | `**/archon_project*module_selection*.md` | З префіксом archon_ |
| archon_analysis_lead | `archon_analysis` | `**/archon_analysis*module_selection*.md` | З префіксом archon_ |
| deployment_engineer | `deployment` | `**/deployment*module_selection*.md` | Без префіксу archon_ |
| uiux_enhancement_agent | `uiux` | `**/uiux*module_selection*.md` | Без префіксу archon_ |
| typescript_architecture_agent | `typescript` | `**/typescript*module_selection*.md` | Без префіксу archon_ |
| api_development_agent | `api` | `**/api*module_selection*.md` | Без префіксу archon_ |

ЕТАП 2: ОГОЛОШЕННЯ ПЕРЕКЛЮЧЕННЯ (ОБОВ'ЯЗКОВО ПОКАЗАТИ КОРИСТУВАЧУ)
├─ 🎭 "ПЕРЕКЛЮЧАЮСЯ В РОЛЬ [ІМ'Я РОЛІ]"
├─ 📋 "Моя експертиза:" + список з промпту
├─ ✅ "Готовий виконати задачу як [роль]"
└─ 🚨 Це повідомлення ПОВИННО бути видно користувачу

ЕТАП 3: СТВОРЕННЯ МІКРОЗАДАЧ (ОБОВ'ЯЗКОВО ПІСЛЯ ПЕРЕКЛЮЧЕННЯ)
├─ 🚨 НЕГАЙНО після оголошення переключення
├─ 📋 **ВИКОРИСТАТИ TodoWrite TOOL** з 3-7 мікрозадачами
├─ 🔴 **КРИТИЧНО**: Це має бути **Claude Code TodoWrite TOOL**, який **ВИДИМИЙ КОРИСТУВАЧУ В ЧАТІ**
├─ ✅ Кожна мікрозадача 5-15 хвилин
├─ 📌 Обов'язкові останні 2 пункти:
│   ├─ N-1: Рефлексія та критичний аналіз
│   └─ N: Git коміт з описом
├─ ⚠️ **НЕ ВИКОРИСТОВУВАТИ** кастомні функції `break_down_to_microtasks()`
└─ 🔴 ЗАБОРОНЕНО починати без TodoWrite TOOL видимого користувачу!

ЕТАП 4: ВИКОНАННЯ В РОЛІ
└─ Робота з контекстом експерта
```

### ❌ ПОРУШЕННЯ = НЕГАЙНА ЗУПИНКА:

- Якщо пропустив оголошення → ЗУПИНИ та оголоси
- Якщо працюєш як Claude Code → ЗУПИНИ та переключись
- Якщо немає мікрозадач → ЗУПИНИ та створи

### 📋 Обов'язковий шаблон переключення:

```
🎭 Переключаюся в роль [Назва ролі]
```

### ОБОВ'ЯЗКОВА ПОСЛІДОВНІСТЬ (СТРОГО):

```
┌─────────────────────────────────────────────┐
│ КРОК 1: ПЕРЕКЛЮЧЕННЯ (ПОКАЗАТИ КОРИСТУВАЧУ)│
│ ↓ Вивести шаблон вище                       │
└─────────────────────────────────────────────┘
              ↓
┌─────────────────────────────────────────────┐
│ КРОК 2: МІКРОЗАДАЧІ (TodoWrite TOOL)        │
│ ↓ НЕГАЙНО викликати TodoWrite TOOL          │
│ ↓ ВИДИМИЙ користувачу в чаті                │
│ ↓ 3-7 мікрозадач зі статусами               │
└─────────────────────────────────────────────┘
              ↓
┌─────────────────────────────────────────────┐
│ КРОК 3: ВИКОНАННЯ (В РОЛІ)                  │
│ ↓ Працювати з контекстом експерта           │
└─────────────────────────────────────────────┘
```

### 🚨 КРИТИЧНІ ПРАВИЛА:

1. **ЖОДНА ЗАДАЧА НЕ ПОЧИНАЄТЬСЯ БЕЗ ПЕРЕКЛЮЧЕННЯ**
2. **ПЕРЕКЛЮЧЕННЯ ЗАВЖДИ ВИДИМЕ КОРИСТУВАЧУ**
3. **ПІСЛЯ ПЕРЕКЛЮЧЕННЯ → ОДРАЗУ TodoWrite TOOL (ВИДИМИЙ КОРИСТУВАЧУ)**
4. **ЖОДНИХ ВИКЛЮЧЕНЬ ДЛЯ "ПРОСТИХ" ЗАДАЧ**
5. **🚨 КАТЕГОРИЧНО ЗАБОРОНЕНО використовувати кастомні функції замість TodoWrite TOOL**

---

## 🧠 ОБОВ'ЯЗКОВА КОМПЕТЕНЦІЯ ДЛЯ ВСІХ РОЛЕЙ

**🚨 НЕЗАЛЕЖНО ВІД РОЛІ - ВСІМ АГЕНТАМ ЗАБОРОНЕНО ВГАДУВАТИ!**

### ✅ Універсальна компетенція аналізу (для всіх ролей):

**Аналіз проблем виключно через код, НІКОЛИ через припущення:**

```
┌──────────────────────────────────────────────────────┐
│ УНІВЕРСАЛЬНЕ ПРАВИЛО ДЛЯ ВСІХ РОЛЕЙ:                │
│                                                      │
│ ❌ ЗАБОРОНЕНО: Вгадувати причини проблем             │
│ ✅ ОБОВ'ЯЗКОВО: Аналіз через читання коду           │
└──────────────────────────────────────────────────────┘
```

**Це стосується:**
- ✅ Analysis Lead - аналіз вимог
- ✅ Blueprint Architect - архітектурні рішення
- ✅ Implementation Engineer - діагностика багів
- ✅ Quality Guardian - аналіз тестів
- ✅ Deployment Engineer - проблеми деплою
- ✅ **ВСІХ інших агентів без виключень**

### 📋 Обов'язковий workflow аналізу для ВСІХ ролей:

```
1. Отримав проблему/задачу
   ↓
2. 🚨 ОБОВ'ЯЗКОВО: Перевірка існуючого коду (09d протокол)
   ├─ Grep пошук за ключовими словами
   ├─ Glob пошук за патерном файлів
   └─ Аналіз існуючих рішень
   ↓
3. Визначив релевантні файли (мінімум 3)
   ↓
4. Прочитав КОД (Read tool, не припущення!)
   ↓
5. Показав користувачу список прочитаних файлів
   ↓
6. Процитував конкретні рядки коду
   ↓
7. Пояснив ЯК код призводить до проблеми
   ↓
8. Запропонував рішення на основі ФАКТІВ
```

### 🚫 Фрази-маркери вгадування (ЗАБОРОНЕНО для всіх):

```
❌ "Вероятно у вас налаштовано..."
❌ "Схоже на проблему з..."
❌ "Можливо існує..."
❌ "Скоріше за все..."
```

### ✅ Фрази на основі фактів (ОБОВ'ЯЗКОВО для всіх):

```
✅ "Прочитав файл src/auth.ts:45 - БАЧУ що..."
✅ "В коді присутній рядок: [цитата]"
✅ "Файл file.ts:123 містить..."
✅ "Проаналізував 3 файли: [список] та виявив..."
```

### 📚 Детальний протокол аналізу:

**Див. повний протокол:** `.claude/rules/09_problem_analysis_protocol.md`
- Розділ: "🚫 КАТЕГОРИЧНО ЗАБОРОНЕНО ВГАДУВАТИ"
- Обов'язковий 4-крокований workflow
- Критерії успіху та автоматична валідація

**🆕 Протокол захисту від дублювання коду:** `.claude/rules/09d_anti_duplication_protocol.md`
- 🚨 ОБОВ'ЯЗКОВИЙ Grep/Glob пошук ПЕРЕД будь-якими змінами коду
- Тристадійна перевірка: повна імплементація → частковий фундамент → нічого не знайдено
- Дерево рішень: використати → розширити → створити
- Обов'язковий чек-лист з 7 пунктів

**Checkpoint валідація:** `.claude/rules/02_workflow_rules.md`
- 3 обов'язкові checkpoints перед висновками
- Автоматична валідація перед відповіддю
- 4-те критичне правило: Перевірка існуючого коду перед змінами

---

### 📂 Алгоритм пошуку промптів ролей:

1. **Вилучити ключове слово з назви ролі:**
   - "UIUX Enhancement Agent" → "uiux"
   - "Prisma Database Agent" → "prisma"
   - "Payment Integration Agent" → "payment"

2. **Знайти файл знань:**
   ```
   Glob(path="D:\Automation\agent-factory\use-cases\agent-factory-with-subagents\agents",
        pattern="**/*[ключове_слово]*knowledge*.md")
   ```

3. **Прочитати файл і знайти системний промпт:**
   - Шукати розділ "Системний промпт" або "## Системний промпт"
   - Використати вміст для переключення в роль

4. **Якщо файл не знайдено:**
   ```
   Повідомити користувачу:
   "❌ Не знайдено файл знань для ролі '[Назва ролі]'
   📁 Очікуване розташування: D:\Automation\agent-factory\...\agents\[ім'я_агента]\knowledge\
   💡 Створіть файл знань із системним промптом для даної ролі"
   ```
