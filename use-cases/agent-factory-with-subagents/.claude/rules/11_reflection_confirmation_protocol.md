# 11. Reflection & Confirmation Protocol - Протокол рефлексії та підтвердження

## 🚨 БЛОКУЮЧЕ ПРАВИЛО: ОБОВ'ЯЗКОВЕ ПІДТВЕРДЖЕННЯ ПІСЛЯ РЕФЛЕКСІЇ

**Single Source of Truth для всіх правил про рефлексію та підтвердження покращень**

---

## 📋 ЗМІСТ

1. [Чому це критично важливо](#чому-це-критично-важливо)
2. [Два етапи: Мікрозадача vs Post-Task](#два-етапи-мікрозадача-vs-post-task)
3. [ЕТАП 1: Мікрозадача "Рефлексія" (під час роботи)](#етап-1-мікрозадача-рефлексія-під-час-роботи)
4. [ЕТАП 2: Post-Task КРОК 0A (перед завершенням)](#етап-2-post-task-крок-0a-перед-завершенням)
5. [Блокуючий алгоритм підтвердження](#блокуючий-алгоритм-підтвердження)
6. [Псевдокод валідації](#псевдокод-валідації)
7. [Заборонені паттерни](#заборонені-паттерни)
8. [Типові категорії покращень](#типові-категорії-покращень)

---

## 🎯 Чому це критично важливо

**Проблема:** Агенти виконують рефлексію, знаходять проблеми, але НЕ запитують підтвердження користувача перед застосуванням покращень.

**Наслідки:**
- Користувач втрачає контроль над процесом
- Агент може застосувати небажані зміни
- Порушується принцип "human-in-the-loop"

**Рішення:** БЛОКУЮЧИЙ протокол підтвердження після кожної рефлексії.

---

## 🔄 Два етапи: Мікрозадача vs Post-Task

**ВАЖЛИВО:** Є ДВА місця де відбувається рефлексія, і вони мають РІЗНІ цілі!

### 🎯 Відмінності:

| Аспект | Мікрозадача "Рефлексія" | Post-Task КРОК 0A |
|--------|-------------------------|-------------------|
| **Коли** | Під час виконання задачі | Перед завершенням задачі |
| **Мета** | Покращити поточний результат | Перевірити що підтвердження виконано |
| **Дія** | Виконати рефлексію + запит | Валідувати що запит був |
| **Статус** | Задача ще в процесі | Задача майже готова |
| **Обов'язковість** | Якщо є що покращити | ЗАВЖДИ перед завершенням |

### 📊 Workflow:

```
1. Виконання основних кроків
   ↓
2. 📍 МІКРОЗАДАЧА "Рефлексія" (ЕТАП 1)
   ├─ Знайти покращення
   ├─ 🛑 ЗАПИТАТИ підтвердження (БЛОКУЮЧЕ!)
   ├─ ЧЕКАТИ відповіді
   └─ Застосувати якщо "так"
   ↓
3. Git коміт (якщо застосовано покращення)
   ↓
4. 📍 POST-TASK КРОК 0A (ЕТАП 2)
   ├─ Перевірити що ЕТАП 1 був виконаний
   ├─ Валідувати що підтвердження запитано
   └─ Якщо пропущено → ЗУПИНИТИСЬ та виправити
   ↓
5. Оновлення статусу в Archon (КРОК 0)
   ↓
6. Решта Post-Task Checklist
```

---

## 🔍 ЕТАП 1: Мікрозадача "Рефлексія" (під час роботи)

**Розміщення в TodoWrite:** Перед git commit, але після основної роботи

### 📝 Обов'язкова структура мікрозадачі:

```python
TodoWrite([
    # ... основні кроки роботи ...

    # ОБОВ'ЯЗКОВА рефлексія перед git commit
    {"content": "Рефлексія: перевірити якість результату та знайти покращення",
     "status": "pending",
     "activeForm": "Виконую рефлексію"},

    # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    # 🚨 БЛОКУЮЧЕ ПРАВИЛО: ОБОВ'ЯЗКОВЕ ПІДТВЕРДЖЕННЯ
    # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    # ЗАБОРОНЕНО продовжувати без підтвердження користувача!
    # Агент ПОВИНЕН ЗУПИНИТИСЯ та чекати відповіді!
    {"content": "🚨 ОБОВ'ЯЗКОВО спросити пользователя: применить улучшения сейчас или создать отдельную задачу? (ЧЕКАТИ ВІДПОВІДІ!)",
     "status": "pending",
     "activeForm": "🚨 Спрашиваю пользователя о применении улучшений (БЛОКУЮЧЕ)"},

    # Застосування покращень (якщо користувач підтвердив)
    {"content": "ЯКЩО користувач обрав 'Застосувати зараз' → НЕГАЙНО реалізувати ВСІ знайдені покращення",
     "status": "pending",
     "activeForm": "Застосовую покращення з рефлексії"},

    # Git коміт (ПІСЛЯ застосування покращень якщо вони були)
    {"content": "Git commit з описом виконаної роботи",
     "status": "pending",
     "activeForm": "Створюю git commit"},

    # Post-Task Checklist (ЗАВЖДИ останній пункт)
    {"content": "Виконати Post-Task Checklist (.claude/rules/10_post_task_checklist.md) [TASK_ID: {task_id}]",
     "status": "pending",
     "activeForm": "Виконую Post-Task Checklist"}
])
```

### 🎯 Критичні правила ЕТАП 1:

1. **Рефлексія** - обов'язковий пункт (знайти недоліки, запропонувати покращення)

2. **🔴 БЛОКУЮЧЕ: Запит підтвердження** - ОБОВ'ЯЗКОВО після рефлексії спитати користувача про застосування покращень
   - **ЗАБОРОНЕНО** продовжувати без відповіді користувача
   - **ЗАБОРОНЕНО** пропускати цей крок
   - **ОБОВ'ЯЗКОВО** зупинитися та чекати відповіді

   **Варіанти відповіді:**
   - Варіант 1: Застосувати покращення зараз (в рамках поточної задачі)
   - Варіант 2: Створити окрему задачу в Archon для покращень
   - Варіант 3: Пропустити покращення

3. **🚨 НЕГАЙНЕ ЗАСТОСУВАННЯ** - якщо користувач обрав варіант 1 → ОБОВ'ЯЗКОВО реалізувати ВСІ знайдені покращення перед git commit
   - ❌ ЗАБОРОНЕНО ігнорувати покращення після підтвердження
   - ❌ ЗАБОРОНЕНО робити git commit без застосування покращень
   - ✅ ОБОВ'ЯЗКОВО застосувати КОЖНЕ знайдене покращення

4. **Git commit** - після застосування покращень (якщо користувач підтвердив) або без них

### 📝 Обов'язкова форма запиту підтвердження:

```
## 🔍 РЕФЛЕКСІЯ:

Знайдені потенційні покращення:

**Покращення 1**: [опис першого покращення]
**Покращення 2**: [опис другого покращення]
**Покращення 3**: [опис третього покращення]

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
**Оберіть варіант:**

1. **Застосувати покращення зараз** 🚨 (НЕГАЙНО реалізую ВСІ знайдені покращення, потім git commit)
2. **Створити окрему задачу в Archon** (закінчу поточну задачу, створю нову для покращень)
3. **Пропустити покращення** (залишити як є, зробити тільки git commit)

❓ Ваш вибір? (1/2/3)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

**❗ ВАЖЛИВО:** Якщо обрано варіант 1 - агент ОБОВ'ЯЗКОВО негайно реалізує ВСІ покращення перед git commit!
```

---

## ✅ ЕТАП 2: Post-Task КРОК 0A (перед завершенням)

**Розміщення:** В `10_post_task_checklist.md` → перед КРОК 0 (оновлення статусу)

**Мета:** Перевірити що ЕТАП 1 був виконаний правильно (валідація)

### 📋 Послідовність дій КРОК 0A:

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🔍 КРОК 0A: ВАЛІДАЦІЯ РЕФЛЕКСІЇ ТА ПІДТВЕРДЖЕННЯ
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

1. ✅ Перевірити: чи була виконана мікрозадача "Рефлексія"?
   └─ Якщо НІ → ЗУПИНИТИСЬ та виконати ЕТАП 1

2. ✅ Перевірити: чи було запитано підтвердження користувача?
   └─ Якщо НІ → ЗУПИНИТИСЬ та виконати запит

3. ✅ Перевірити: чи була отримана відповідь від користувача?
   └─ Якщо НІ → ЧЕКАТИ відповіді

4. ✅ Перевірити: чи були застосовані покращення (якщо користувач обрав варіант 1)?
   └─ Якщо НІ → ЗУПИНИТИСЬ та застосувати

5. ✅ Тільки якщо ВСІ перевірки пройдені → продовжити до КРОК 0
```

**Ключова відмінність:** КРОК 0A НЕ виконує рефлексію, а ВАЛІДУЄ що вона була виконана!

---

## 🛑 Блокуючий алгоритм підтвердження

**Python псевдокод для розуміння:**

```python
async def reflection_workflow():
    """
    Обов'язковий workflow після рефлексії.

    🚨 БЛОКУЮЧЕ ПРАВИЛО: Агент НЕ МОЖЕ продовжити без підтвердження!
    """

    # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    # КРОК 1: Провести критичний аналіз
    # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    analysis = await perform_critical_analysis()

    # Знайти мінімум 2-3 покращення
    improvements = analysis.find_improvements(min_count=2)

    if not improvements:
        print("⚠️ ПОПЕРЕДЖЕННЯ: Не знайдено покращень!")
        print("🔍 Спробуйте глибший аналіз або інші категорії")
        # Повторити аналіз з іншими категоріями
        improvements = analysis.find_improvements_deep()

    # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    # КРОК 2: Вивести рефлексію користувачу
    # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    print_reflection_template(analysis)

    # Показати знайдені покращення з категоріями
    for i, improvement in enumerate(improvements, 1):
        print(f"**Покращення {i}** [{improvement.category}]: {improvement.description}")

    # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    # КРОК 3: 🚨 ЗАПИТАТИ ДОЗВІЛ (БЛОКУЮЧЕ!)
    # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    print("\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━")
    print("**Оберіть варіант:**")
    print("1. Застосувати покращення зараз 🚨")
    print("2. Створити окрему задачу в Archon")
    print("3. Пропустити покращення")
    print("\n❓ Ваш вибір? (1/2/3)")
    print("━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━")

    # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    # КРОК 4: 🛑 STOP - ЗУПИНИТИСЯ - ЧЕКАТИ ВІДПОВІДІ
    # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    # 🚨 ЗАБОРОНЕНО продовжувати без дозволу!
    # 🚨 ЗАБОРОНЕНО пропускати цей крок!
    # 🚨 ЗАБОРОНЕНО автоматично застосовувати покращення!
    # ⏸️ WAIT - агент повинен ЗУПИНИТИСЯ тут та ЧЕКАТИ!

    user_response = await wait_for_user_response()  # БЛОКУЮЧЕ ОЧІКУВАННЯ!

    # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    # КРОК 5: Тільки ПІСЛЯ відповіді виконати дію
    # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    if user_response == "1":
        print("✅ Застосовую ВСІ покращення негайно...")
        for improvement in improvements:
            await apply_improvement(improvement)
            print(f"  ✓ Застосовано: {improvement.description}")
        print("✅ Всі покращення застосовані")

    elif user_response == "2":
        print("📋 Створюю окрему задачу в Archon...")
        await create_improvement_task(
            improvements=improvements,
            project_id=current_project_id
        )
        print("✅ Задача створена")

    else:  # "3" або інше
        print("⏭️ Покращення пропущені, продовжуємо")

    # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    # КРОК 6: Тільки ПІСЛЯ цього - git коміт та наступні кроки
    # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    return user_response
```

---

## 🔍 Псевдокод валідації

**Функція самоперевірки для агентів:**

```python
async def validate_reflection_confirmation() -> bool:
    """
    Валідація виконання протоколу рефлексії та підтвердження.

    Використовується в Post-Task КРОК 0A для перевірки.

    Returns:
        bool: True якщо всі кроки виконані, False якщо потрібно виправлення
    """

    # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    # ПЕРЕВІРКА 1: Чи була виконана рефлексія?
    # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    if not reflection_performed:
        print("❌ ПОМИЛКА: Рефлексія НЕ була виконана!")
        print("🛑 ЗУПИНИТИСЬ та виконати ЕТАП 1 (мікрозадача 'Рефлексія')")
        return False

    # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    # ПЕРЕВІРКА 2: Чи було запитано підтвердження?
    # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    if not confirmation_requested:
        print("❌ ПОМИЛКА: Підтвердження НЕ було запитано!")
        print("🛑 ЗУПИНИТИСЬ та виконати запит підтвердження")
        print("📋 Формат: '❓ Вносити запропоновані покращення? (так/ні)'")
        return False

    # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    # ПЕРЕВІРКА 3: Чи була отримана відповідь?
    # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    if not user_response_received:
        print("⏸️ ОЧІКУВАННЯ: Відповідь користувача не отримана")
        print("🛑 ЗУПИНИТИСЬ та ЧЕКАТИ відповіді")
        return False

    # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    # ПЕРЕВІРКА 4: Чи були застосовані покращення (якщо обрано варіант 1)?
    # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    if user_response == "1" and not improvements_applied:
        print("❌ ПОМИЛКА: Користувач обрав 'Застосувати зараз', але покращення НЕ застосовані!")
        print("🛑 ЗУПИНИТИСЬ та НЕГАЙНО застосувати ВСІ покращення")
        return False

    # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    # ВСІ ПЕРЕВІРКИ ПРОЙДЕНІ ✅
    # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    print("✅ Валідація пройдена: протокол рефлексії виконано правильно")
    return True


# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# ВИКОРИСТАННЯ В POST-TASK CHECKLIST
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

async def post_task_checklist():
    """Post-Task Checklist з валідацією."""

    print("[КРОК 0A] Валідація рефлексії та підтвердження...")

    is_valid = await validate_reflection_confirmation()

    if not is_valid:
        print("🚨 КРИТИЧНА ПОМИЛКА: Протокол рефлексії порушено!")
        print("🛑 ЗУПИНКА виконання Post-Task Checklist")
        print("📋 Виправте помилки та повторіть валідацію")
        raise ValidationError("Reflection confirmation protocol not followed")

    print("[КРОК 0] Оновлення статусу задачі в Archon...")
    # ... решта кроків ...
```

---

## ❌ Заборонені паттерни

### 🚫 НЕПРАВИЛЬНО #1: Пропустити запит підтвердження

```
❌ ЗАБОРОНЕНО:
"Провів рефлексію. Виявив проблеми A, B, C.
Наступна задача: ..."

[ПРОПУСТИВ ЗАПИТ ПІДТВЕРДЖЕННЯ!]
```

### 🚫 НЕПРАВИЛЬНО #2: Не чекати відповіді

```
❌ ЗАБОРОНЕНО:
"Рефлексія: знайшов 3 проблеми.
Оновлюю статус в Archon..."

[ПРОПУСТИВ ЧЕКАННЯ ВІДПОВІДІ!]
```

### 🚫 НЕПРАВИЛЬНО #3: Автоматично застосувати без дозволу

```
❌ ЗАБОРОНЕНО:
"Рефлексія: знайшов 3 проблеми.
Застосовую покращення автоматично..."

[ПРОПУСТИВ ЗАПИТ ДОЗВОЛУ!]
```

### ✅ ПРАВИЛЬНО:

```
✅ ПРАВИЛЬНО:
"## 🔍 РЕФЛЕКСІЯ:

Знайдені потенційні покращення:

**Покращення 1**: Додати тести для функції X
**Покращення 2**: Покращити документацію модуля Y
**Покращення 3**: Оптимізувати алгоритм Z

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
**Оберіть варіант:**

1. Застосувати покращення зараз 🚨
2. Створити окрему задачу в Archon
3. Пропустити покращення

❓ Ваш вибір? (1/2/3)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

[ЧЕКАЄ ВІДПОВІДІ - БЛОКУЮЧЕ ОЧІКУВАННЯ!]
```

---

## 🎯 Типові категорії покращень

**Для систематичної рефлексії завжди перевіряй ці категорії:**

### 1. 🏗️ **Архітектура**
- Чи код добре структурований?
- Чи дотримано принципів SOLID?
- Чи є дублювання коду?
- Чи правильно розділено відповідальності?

### 2. 🧪 **Тестування**
- Чи є достатнє покриття тестами?
- Чи покриті edge cases?
- Чи є тести для помилкових сценаріїв?
- Чи можна додати інтеграційні тести?

### 3. 📚 **Документація**
- Чи всі функції мають docstrings?
- Чи є коментарі для складної логіки?
- Чи оновлено README?
- Чи є приклади використання?

### 4. ⚡ **Performance**
- Чи є bottlenecks в коді?
- Чи можна оптимізувати алгоритми?
- Чи правильно використовується кешування?
- Чи є непотрібні обчислення?

### 5. 🔒 **Безпека**
- Чи є потенційні вразливості?
- Чи правильно валідуються входи?
- Чи безпечно зберігаються чутливі дані?
- Чи є захист від типових атак?

### 6. 🎨 **Код стиль та читабельність**
- Чи дотримано PEP8 (для Python)?
- Чи змінні мають зрозумілі імена?
- Чи код легко читається?
- Чи є магічні числа/рядки?

### 7. 🔧 **Maintainability**
- Чи легко буде підтримувати код?
- Чи є tech debt?
- Чи можна спростити логіку?
- Чи є застарілі залежності?

### 8. 🌐 **Compatibility**
- Чи код працює на всіх цільових платформах?
- Чи правильно обробляються залежності?
- Чи є backward compatibility проблеми?

**Приклад систематичної рефлексії:**

```
## 🔍 РЕФЛЕКСІЯ (за категоріями):

### 🏗️ Архітектура:
✅ Структура файлів відповідає стандартам
✅ Принципи SOLID дотримано

### 🧪 Тестування:
⚠️ ПОКРАЩЕННЯ 1: Додати unit тести для функції validate_input() (покриття 65% → 95%)

### 📚 Документація:
⚠️ ПОКРАЩЕННЯ 2: Додати docstrings до класу UserManager (відсутні в 3 методах)

### ⚡ Performance:
✅ Bottlenecks відсутні

### 🔒 Безпека:
⚠️ ПОКРАЩЕННЯ 3: Додати валідацію SQL запитів для захисту від SQL injection

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
❓ Вносити запропоновані покращення? (1/2/3)
```

---

## 📊 Метрики успішності

**Після впровадження цього протоколу очікується:**

- ✅ **95%+ задач з запитом підтвердження** (було: ~40%)
- ✅ **100% задач з рефлексією** (було: ~70%)
- ✅ **0% задач з автоматичним застосуванням покращень** (було: ~30%)
- ✅ **Користувач має контроль** над процесом покращень

---

## 🔗 Посилання на інші правила

**Цей протокол інтегрується з:**

- **common_agent_rules.md** → структура мікрозадач
- **04_quality_standards.md** → ЕТАП 2 та ЕТАП 3
- **10_post_task_checklist.md** → КРОК 0A (валідація)
- **03_task_management.md** → створення задач в Archon

---

## 🎓 Навчальний сценарій

**Приклад правильного виконання:**

```
1. Агент виконує основну роботу (кроки 1-N)
   ✅ Створено функцію validate_user()
   ✅ Додано обробку помилок

2. Агент досягає мікрозадачі "Рефлексія"
   📊 Аналізує код за 8 категоріями
   🔍 Знаходить 3 покращення:
      - Тести відсутні (категорія: Тестування)
      - Docstring неповний (категорія: Документація)
      - SQL injection можливий (категорія: Безпека)

3. 🛑 Агент ЗУПИНЯЄТЬСЯ та запитує підтвердження
   "❓ Ваш вибір? (1/2/3)"

4. ⏸️ Агент ЧЕКАЄ відповіді користувача
   [Користувач обирає "1" - Застосувати зараз]

5. ✅ Агент НЕГАЙНО застосовує ВСІ 3 покращення
   - Додає unit тести (10 тестів)
   - Доповнює docstring (Google style)
   - Додає SQL валідацію (parameterized queries)

6. 📝 Git commit з описом покращень
   "feat: validate_user() + tests + docs + security"

7. ✅ Post-Task КРОК 0A: Валідація
   - Перевірка 1: Рефлексія виконана ✓
   - Перевірка 2: Підтвердження запитано ✓
   - Перевірка 3: Відповідь отримана ✓
   - Перевірка 4: Покращення застосовані ✓

8. ✅ КРОК 0: Оновлення статусу в Archon → "done"

9. ✅ Решта Post-Task Checklist...
```

---

**ВЕРСІЯ:** 1.0
**ДАТА СТВОРЕННЯ:** 2025-11-06
**АВТОР:** Archon Blueprint Architect
**ТОКЕНІВ:** ~2,500

**🚨 ЦЕ КРИТИЧНО ВАЖЛИВИЙ ПРОТОКОЛ - ЗАВЖДИ ВИКОНУЙ ПІДТВЕРДЖЕННЯ ПІСЛЯ РЕФЛЕКСІЇ!**
